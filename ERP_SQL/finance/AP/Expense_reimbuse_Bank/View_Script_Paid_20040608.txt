
--------------------------------------
CREATE OR REPLACE VIEW APPS.BMC_AP_EMPLOYEE_PAYABLE
(RESULT, DUE_DATE, EMPLOYEE_NUMBER, LAST_NAME, INVOICE_AMOUNT, 
 AMOUNT_PAID, AMOUNT_REMAIN, BANK_ACCOUNT_NO, INVOICE_NUM, WFAPPROVAL_STATUS, 
 PAYMENTMETHOD)
AS 
SELECT '05956'||SUBSTR(to_char(PPV.EMPLOYEE_NUMBER),2,6)||PPV.LAST_NAME||RPAD(' ',8-LENGTHB(CONVERT(PPV.LAST_NAME,'ZHS16GBK')),' ')||PPV.ATTRIBUTE1||ltrim(replace(to_char((AIV.INVOICE_AMOUNT-nvl(aiv.amount_paid,0)),'0999999D99'),'.',''))||to_char(sysdate,'YYMMDD') result
       ,APS.DUE_DATE DUE_DATE
       ,PPV.EMPLOYEE_NUMBER
       ,PPV.LAST_NAME
       ,AIV.INVOICE_AMOUNT,aiv.amount_paid,(AIV.INVOICE_AMOUNT-nvl(aiv.amount_paid,0)) amount_remain
       ,PPV.ATTRIBUTE1 BANK_ACCOUNT_NO
       ,AIV.INVOICE_NUM,AIV.WFAPPROVAL_STATUS
       , AIV.ATTRIBUTE2 PaymentMethod
FROM AP_INVOICES_ALL AIV, --AP_INVOICES_V
	   PO_VENDORS PV,
	   PER_PEOPLE_V7 PPV,
	   HR_EMPLOYEES HE,
	   AP_PAYMENT_SCHEDULES_ALL APS--AP_PAYMENT_SCHEDULES 
WHERE PV.VENDOR_ID=AIV.VENDOR_ID
	    AND PV.EMPLOYEE_ID=HE.EMPLOYEE_ID
	    AND HE.EMPLOYEE_NUM=PPV.EMPLOYEE_NUMBER
	    AND AIV.INVOICE_ID=APS.INVOICE_ID
      AND (AIV.ATTRIBUTE2='Bank' or AIV.ATTRIBUTE2 is null)
--	    AND APS.DUE_DATE<=SYSDATE
	    AND (AIV.WFAPPROVAL_STATUS='REQUIRED'
           OR AIV.WFAPPROVAL_STATUS='NOT REQUIRED'
           OR AIV.WFAPPROVAL_STATUS='MANUALLY APPROVED'
           )
      AND AIV.PAYMENT_CURRENCY_CODE='CNY'
	    AND AIV.PAY_GROUP_LOOKUP_CODE='EM'
      AND AIV.INVOICE_TYPE_LOOKUP_CODE='EXPENSE REPORT'
      AND AIV.PAYMENT_STATUS_FLAG<>'Y'      --not fully paid, include no paid and partially paid
      AND LENGTH(PPV.EMPLOYEE_NUMBER)=6   --EMPLOYEE NUMBER LENGTH IS 6
      AND AIV.INVOICE_ID NOT IN           --APPROVAL_STATUS='Validated'
      (SELECT DISTINCT AIDA.INVOICE_ID FROM AP_INVOICE_DISTRIBUTIONS_ALL AIDA WHERE match_status_flag <> 'A' and match_status_flag <> 'T');




